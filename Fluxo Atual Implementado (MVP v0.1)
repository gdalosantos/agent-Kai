FLUXO ATUAL 

FLUXO ATUAL ‚Äî Vers√£o v0.4 (07/11/2025)
======================================

1Ô∏è‚É£ Entrada e Transcri√ß√£o (Whisper)
-----------------------------------
Entrada via Webhook (Make):
- Recebe √°udio (mp3, m4a, wav etc.) pelo endpoint configurado.
- Campos:
  - data ‚Üí bin√°rio do √°udio.
  - name ‚Üí nome do arquivo com extens√£o.

M√≥dulo HTTP (OpenAI Whisper):
- Envia o bin√°rio para https://api.openai.com/v1/audio/transcriptions
- Modelo: whisper-1
- Retorna texto transcrito multil√≠ngue (PT/EN/DE).
- Resultado armazenado em {{12.data.text}}.

‚ú® A transcri√ß√£o √© est√°vel e multil√≠ngue.
O texto bruto serve de fallback para as tesouras (compras, tasks e events).


2Ô∏è‚É£ Classifica√ß√£o Inteligente (GPT ‚Äì Chat Completion)
-----------------------------------------------------
M√≥dulo HTTP (OpenAI Chat Completion):
- Usa o texto transcrito ({{12.data.text}}) no campo "role": "user".
- Retorna JSON puro com 3 arrays obrigat√≥rios:
  {
    "tasks": [{"title": "...", "due": "..."}],
    "compras": ["..."],
    "events": [{"title": "...", "start": "...", "end": "...", "all_day": false, "location": "..."}]
  }

Par√¢metros principais:
- model: gpt-4o
- max_tokens: 200
- temperature: 0
- response_format: { "type": "json_object" }
- endpoint: https://api.openai.com/v1/chat/completions

‚ö†Ô∏è json_schema temporariamente suspenso (erro 400 no Make)
‚öôÔ∏è Vers√£o atual usa json_object + Parse JSON (21) para valida√ß√£o

Prompt:
- Sempre retornar tasks, compras e events (mesmo vazios)
- Separar itens m√∫ltiplos ("e", "and", "und", ";")
- N√£o inferir datas sem clareza ‚Üí deixar due vazio
- N√£o traduzir palavras misturadas PT/EN/DE


3Ô∏è‚É£ Processamento e Tesouras (Make)
-----------------------------------

Ap√≥s Parse JSON (21):
Router (7) distribui para tr√™s rotas independentes: Compras, Tasks e Events.


üõí Rota Compras
---------------
Router (compras) ‚Üí Set variable (compras_split) ‚Üí Iterator ‚Üí Todoist

Tesoura:
map(
  split(
    replace(
      replace(
        replace(
          replace(
            if(
              length(trim(join(21.compras,","))) > 0,
              join(21.compras,","),
              {{12.data.text}}
            ),
            " e ", ","
          ),
          " and ", ","
        ),
        " und ", ","
      ),
      ";", ","
    ),
    ","
  ),
  trim(item)
)

Iterator: Array = compras_split
Todoist Content = Item/Value

‚úÖ Resultado: cada item da lista vira uma tarefa no projeto ‚ÄúCompras‚Äù.


üßæ Rota Tarefas
---------------
Router (tasks) ‚Üí Set variable (tasks_array) ‚Üí Iterator ‚Üí Todoist

Tesoura:
if(
  length(21.tasks) > 0,
  21.tasks,
  map(
    split(
      replace(
        replace(
          replace(
            replace(
              {{12.data.text}},
              " e ", ","
            ),
            " and ", ","
          ),
          " und ", ","
        ),
        ";", ","
      ),
      ","
    ),
    object("title", trim(item), "due", "")
  )
)

Iterator: Array = tasks_array
Todoist Content = Item.title
Due = (desativado)

‚ö†Ô∏è Datas (due) ainda s√£o aleat√≥rias (ex.: "13.10.2023").
Manter campo due vazio at√© corrigir prompt.


üìÖ Rota Eventos
---------------
Router (events) ‚Üí Set variable (events_split) ‚Üí Iterator ‚Üí Filter ‚Üí Google Calendar

Situa√ß√£o:
- Tesoura inicial feita, mas datas inv√°lidas causam erro (Invalid date in parameter 'start')
- Falta formatar com formatDate(parseDate(...)) e criar fallback para start vazio.


4Ô∏è‚É£ Execu√ß√£o e Conectores
-------------------------
Todoist:
- Usado nas rotas de compras e tarefas.
- Iterator evita erro 413 (payload grande).
- Mapeamento:
  - Content = Item.title ou Item/Value
  - Due = vazio

Google Calendar:
- Rota em desenvolvimento.
- Pr√≥ximo passo: corrigir formata√ß√£o RFC3339.

Gmail:
- Ainda n√£o conectado.
- Planejado para rota ‚ÄúComunica√ß√£o‚Äù.


5Ô∏è‚É£ Logs, Rollback e Payloads
-----------------------------
- max_tokens: 200 (limita resposta do GPT)
- Iterator: quebra listas longas em execu√ß√µes separadas
- Rollback: planejado (Data Store)
- Payloads enxutos e idempotentes (evitam duplica√ß√£o)


üß≠ Resumo
---------
| Etapa            | Status | Observa√ß√µes |
|------------------|--------|--------------|
| Whisper ‚Üí Texto  | ‚úÖ | Est√°vel |
| GPT ‚Üí JSON       | ‚úÖ | Funciona, datas imprecisas |
| Compras          | ‚úÖ | Tesoura est√°vel |
| Tasks            | ‚öôÔ∏è | Funciona sem datas |
| Events           | ‚ö†Ô∏è | Falha em start/datas |
| Gmail            | üöß | N√£o conectado |
| Rollback         | üöß | Em planejamento |

‚ö†Ô∏è Aviso:
Manter campo due desativado at√© corrigir gera√ß√£o de datas no GPT
e ajustar formata√ß√£o RFC3339 no Calendar.


-----------------------------------------------
1. Entrada e Transcri√ß√£o
Entrada via Webhook: envia √°udio (formato mp3, m4a, wav, etc.) para endpoint Make configurado.

M√≥dulo HTTP 1 (OpenAI Whisper):

Recebe arquivo bin√°rio (campo data do webhook), nome do arquivo com extens√£o (campo name).

Envia para OpenAI Whisper para transcri√ß√£o.

Retorna texto transcrito (PT/EN/DE misturados).

2. Classifica√ß√£o Inteligente (Chat Completion)
M√≥dulo HTTP 2 (OpenAI Chat Completion):

Usa o texto transcrito no campo "role": "user" via vari√°vel text retornada do Whisper.

Envia contexto e schema JSON restrito para classificar comandos conforme instru√ß√£o do usu√°rio ("compra p√£o e ovos, me lembra de...").

Par√¢metros:

model: gpt-4o

max_tokens: 200

response_format: json_object ou json_schema

temperature: 0

3. Execu√ß√£o Autom√°tica: Tarefas no Todoist
M√≥dulo Todoist (Make):

Recebe array/tarefa j√° classificada do Chat Completion.

Cria cada tarefa individualmente usando Iterator (iterador) para evitar payloads grandes (erro 413).

Mapeia apenas o campo relevante do t√≠tulo da tarefa (tasks.title) no campo ‚Äúcontent‚Äù.

4. Corre√ß√£o de Limites e Payloads
Limita√ß√£o de tokens por requisi√ß√£o garantida com par√¢metro max_tokens.

Iterator configurado para dividir m√∫ltiplas tarefas em chamadas separadas.

Payloads enxutos enviados ao Todoist.

